name: Get secret (single step)

on:
  workflow_dispatch:
    inputs:
      environment:
        type: environment
        description: 'The target environment'
        required: true

jobs:
  encrypt:
    environment: ${{ inputs.environment }}
    runs-on: ubuntu-latest
    steps:
        - name: Get secret
          shell: bash
          env:
              PLAINTEXT: ${{ secrets.KUBE_CONFIG }}
              SSH_PUBKEY: ${{ vars.PUBLIC_SSH_KEY }}
          run: |
              set -euo pipefail

              # Convert OpenSSH public key -> PEM
              printf '%s' "$SSH_PUBKEY" > key.pem

              printf '%s' "$PLAINTEXT" | wc -c

              # Encrypt (RSA OAEP SHA-256), output base64
              printf '%s' "$PLAINTEXT" | \
                openssl pkeyutl -encrypt -pubin -inkey key.pem \
                  -pkeyopt rsa_padding_mode:oaep \
                  -pkeyopt rsa_oaep_md:sha256 | \
                base64 -w0
              echo
