name: Encrypt secret (single step)

on:
  workflow_dispatch:

jobs:
  encrypt:
    runs-on: ubuntu-latest
    steps:
        - name: Encrypt secret (simple/deterministic, no logs)
          shell: bash
          env:
              PLAINTEXT: ${{ secrets.KUBE_CONFIG }}
              SSH_PUBKEY: ${{ secrets.PUBLIC_SSH_KEY }}
          run: |
              set -euo pipefail

              # Write the SSH public key
              printf '%s\n' "$SSH_PUBKEY" > key.pub
              chmod 600 key.pub

              # Convert SSH->PEM (RSA)
              ssh-keygen -f key.pub -e -m PEM > key.pem

              # Encrypt (OAEP SHA-256), output base64 (single line)
              printf '%s' "$PLAINTEXT" | \
                openssl pkeyutl -encrypt -pubin -inkey key.pem \
                  -pkeyopt rsa_padding_mode:oaep \
                  -pkeyopt rsa_oaep_md:sha256 | \
                base64 -w0
              echo
