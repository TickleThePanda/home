---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: timelapse-deployment
  labels:
    app: timelapse
  namespace: home
spec:
  selector:
    matchLabels:
      app: timelapse
  template:
    metadata:
      labels:
        app: timelapse
    spec:
      containers:
      - name: timelapse
        image: ticklethepanda/rpi-timelapse:latest
        env:
        - name: SPEED_TEST_SITE_ROOT
          value: "/timelapse"
        - name: RPI_CAMERA_STORAGE_DIR
          value: "/data"
        ports:
        - containerPort: 80
        securityContext:
          runAsNonRoot: true
          runAsUser: 10001
          capabilities:
            drop:
              - all
            add:
              - NET_BIND_SERVICE
        volumeMounts:
        - mountPath: /data
          name: timelapse-volume
        - mountPath: /dev/vcsm-cma
          name: timelapse-vcsm-cma
        - mountPath: /dev/vchiq
          name: timelapse-vchiq
      tolerations:
      - key: "pi-camera"
        operator: "Exists"
        effect: "NoSchedule"
      volumes:
        - name: timelapse-volume
          persistentVolumeClaim:
            claimName: timelapse-pvc
        - name: timelapse-vcsm-cma
          hostPath:
            path: /dev/vcsm
        - name: timelapse-vchiq
          hostPath:
            path: /dev/vchiq
